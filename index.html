<!DOCTYPE html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="EstudiApp - Tu organizador universitario"
    />
    <title>EstudiApp</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icons/icon-192x192.png" type="image/png" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <!-- Preload critical resources -->
    <link rel="preload" href="css/variables.css" as="style" />
    <link rel="preload" href="css/base.css" as="style" />
    <link rel="preload" href="css/layout.css" as="style" />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      as="style"
    />

    <!-- Critical CSS - Above the fold -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/themes.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/buttons.css" />
    <link rel="stylesheet" href="css/navigation.css" />
    <link rel="stylesheet" href="css/menu.css" />
    <link rel="stylesheet" href="css/loading.css" />

    <!-- Non-critical CSS - Load asynchronously -->
    <link
      rel="preload"
      href="css/modals.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/streak-section.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/animations.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/timer-effects.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/calendar.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/events.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/timer.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/subjects.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/forms.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      rel="preload"
      href="css/responsive.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />

    <!-- Fallback for browsers that don't support preload -->
    <noscript>
      <link rel="stylesheet" href="css/modals.css" />
      <link rel="stylesheet" href="css/streak-section.css" />
      <link rel="stylesheet" href="css/animations.css" />
      <link rel="stylesheet" href="css/timer-effects.css" />
      <link rel="stylesheet" href="css/calendar.css" />
      <link rel="stylesheet" href="css/events.css" />
      <link rel="stylesheet" href="css/timer.css" />
      <link rel="stylesheet" href="css/subjects.css" />
      <link rel="stylesheet" href="css/subjects-professional.css" />
      <link rel="stylesheet" href="css/subjects-favorites.css" />
      <link rel="stylesheet" href="css/forms.css" />
      <link rel="stylesheet" href="css/responsive.css" />
    </noscript>

    <!-- Load Google Fonts asynchronously -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
      <div class="loading-content">
        <div class="loading-logo">
          <h1>EstudiApp</h1>
        </div>
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <p class="loading-text">Cargando tu espacio de estudio...</p>
      </div>
    </div>

    <div class="app-container">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <h1>EstudiApp</h1>
        </div>

        <div class="header-right">
          <div class="menu-container">
            <button id="menuToggle" class="menu-toggle" aria-label="Abrir men√∫">
              <span class="hamburger-line"></span>
              <span class="hamburger-line"></span>
              <span class="hamburger-line"></span>
            </button>
          </div>
        </div>
      </header>

      <!-- Men√∫ lateral full-height -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
      <nav class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-header">
          <h2 class="sidebar-title">EstudiApp</h2>
          <button class="sidebar-close" id="sidebarClose">
            <span class="close-line"></span>
            <span class="close-line"></span>
          </button>
        </div>

        <div class="sidebar-content">
          <ul class="sidebar-nav">
            <li class="nav-item">
              <a
                href="index.html"
                class="nav-link active"
                data-section="inicio"
              >
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Inicio</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="materias.html" class="nav-link" data-section="materias">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Materias</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="configuraciones">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Configuraciones</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="donaciones">
                <span class="nav-icon">üíù</span>
                <span class="nav-text">Donaciones</span>
              </a>
            </li>
          </ul>

          <div class="sidebar-divider"></div>

          <div class="sidebar-footer">
            <button id="darkModeToggle" class="theme-toggle-btn">
              <span class="theme-icon">üåô</span>
              <span class="theme-text">Modo Oscuro</span>
            </button>
          </div>
        </div>
      </nav>

      <!-- Main Dashboard -->
      <main class="main">
        <!-- Sistema de Rachas Compacto -->
        <section class="card streak-section compact-streak">
          <div class="streak-compact-header" onclick="toggleStreakExpansion()">
            <div class="streak-compact-info">
              <div class="streak-fire-icon" id="streakFireIcon"></div>
              <div class="streak-compact-stats">
                <span class="compact-streak-number" id="compactCurrentStreak"
                  >0</span
                >
                <span class="compact-streak-label">d√≠as</span>
              </div>
              <div class="streak-compact-progress">
                <div class="compact-progress-bar">
                  <div
                    id="compactProgressFill"
                    class="compact-progress-fill"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="compact-time-display" id="compactTimeDisplay"
                  >0/30 min</span
                >
              </div>
            </div>
            <button class="streak-expand-btn" id="streakExpandBtn">
              <span class="expand-icon">‚ñº</span>
            </button>
          </div>

          <div
            class="streak-expanded-content"
            id="streakExpandedContent"
            style="display: none"
          >
            <!-- Contenido movido al modal streakStatsModal -->
          </div>
        </section>

        <!-- Upcoming Events -->
        <section class="card upcoming-section">
          <h2>Pr√≥ximos Eventos</h2>
          <div id="upcomingEvents"></div>
        </section>

        <!-- Subjects Section Mejorada -->
        <section class="card subjects-section">
          <div class="card-header">
            <h2>Mis Materias Favoritas</h2>
          </div>
          <div id="subjectsList" class="subjects-expandable-list"></div>
        </section>

        <!-- Calendar -->
        <section class="card calendar-section">
          <div class="card-header">
            <h2>Calendario</h2>
            <!-- Bot√≥n eliminado -->
          </div>
          <div id="calendar"></div>
        </section>

        <!-- Todos los Eventos -->
        <section class="card events-list-section">
          <div class="card-header">
            <h2>Todos los Eventos</h2>
            <div class="events-filters">
              <select id="eventFilter" onchange="renderAllEvents()">
                <option value="all">Todos</option>
                <option value="pending">Pendientes</option>
                <option value="completed">Completados</option>
                <option value="upcoming">Pr√≥ximos 7 d√≠as</option>
              </select>
            </div>
          </div>
          <div id="allEventsList" class="events-list"></div>
        </section>

        <!-- Pomodoro Timer -->
        <section class="card pomodoro-section timer-section">
          <div class="card-header">
            <h2>üçÖ Pomodoro</h2>
            <button
              onclick="openModal('pomodoroConfigModal')"
              class="btn-small"
            >
              ‚öôÔ∏è
            </button>
          </div>
          <div class="pomodoro-timer">
            <div class="session-info">
              <h3 id="sessionTitle" class="session-title">Tiempo de estudio</h3>
              <div id="sessionProgress" class="session-progress">
                <div class="progress-bar">
                  <div
                    id="sessionProgressFill"
                    class="progress-fill"
                    style="width: 0%"
                  ></div>
                </div>
                <span id="sessionProgressText">Segmento 1 de 3</span>
              </div>
            </div>

            <div class="timer-display" id="timerDisplay">00:00</div>

            <div class="timer-controls">
              <button id="startTimer" class="btn-timer">‚ñ∂Ô∏è</button>
              <button id="pauseTimer" class="btn-timer hidden">‚è∏Ô∏è</button>
              <button id="resetTimer" class="btn-timer">üîÑ</button>
            </div>

            <div class="timer-info">
              <p class="timer-description" id="timerDescription">
                Sesi√≥n de estudio enfocado
              </p>
              <p id="pomodoroStatus" class="timer-status">
                Listo para comenzar
              </p>
              <div class="session-schedule" id="sessionSchedule"></div>
            </div>
          </div>
        </section>
      </main>

      <!-- Modals -->

      <div id="reminderModal" class="modal">
        <div class="modal-content">
          <h3>Agregar Recordatorio</h3>
          <input type="text" id="reminderTitle" placeholder="T√≠tulo" required />
          <select id="reminderSubject"></select>
          <div class="datetime-container">
            <label for="reminderTime">Hora del evento:</label>
            <input type="time" id="reminderTime" required />
            <input type="hidden" id="reminderDate" />
          </div>
          <textarea
            id="reminderDescription"
            placeholder="Descripci√≥n (opcional)"
            rows="3"
          ></textarea>
          <div class="modal-actions">
            <button onclick="closeModal('reminderModal')" class="btn-cancel">
              Cancelar
            </button>
            <button onclick="addReminder()" class="btn-confirm">Agregar</button>
          </div>
        </div>
      </div>

      <!-- Modal de detalles de materia eliminado - ahora se usa materia-detalle.html -->

      <!-- Modal para estad√≠sticas de rachas -->
      <div id="streakStatsModal" class="modal">
        <div class="modal-content streak-modal-content">
          <div class="streak-modal-header">
            <h3>Estad√≠sticas de Rachas</h3>
            <button
              onclick="closeModal('streakStatsModal')"
              class="modal-close-btn"
            >
              ‚úï
            </button>
          </div>

          <div class="streak-modal-body">
            <div class="streak-top-stats">
              <div class="streak-stat-item">
                <span class="streak-number" id="modalCurrentStreak">0</span>
                <span class="streak-label">D√≠as consecutivos</span>
              </div>
              <div class="streak-stat-item">
                <span class="streak-number" id="modalRealTimeMinutes">0</span>
                <span class="streak-label">Minutos hoy</span>
              </div>
            </div>

            <div class="daily-goal-detailed">
              <div class="goal-progress">
                <div class="goal-header">
                  <span
                    >Objetivo diario:
                    <span id="modalDailyGoalTime">60</span> min</span
                  >
                  <span class="minimum-indicator">M√≠nimo: 30 min</span>
                </div>
                <div class="progress-bar">
                  <div
                    id="modalDailyProgressFill"
                    class="progress-fill"
                    style="width: 0%"
                  ></div>
                </div>
                <div class="progress-text">
                  <span id="modalTodayStudyTime">0</span> /
                  <span id="modalGoalTime">60</span> min
                  <span
                    class="real-time-indicator"
                    id="modalRealTimeIndicator"
                  ></span>
                </div>
              </div>
            </div>

            <div class="streak-bottom-stats">
              <div class="streak-stat-item best-streak">
                <span class="streak-number" id="modalBestStreak">0</span>
                <span class="streak-label">Mejor racha</span>
              </div>
            </div>

            <div class="streak-actions">
              <button onclick="openModal('goalModal')" class="btn-secondary">
                ‚öôÔ∏è Configurar
              </button>
              <button onclick="shareStreak()" class="btn-share">
                üì§ Compartir
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Al final del body, antes del cierre -->
    <!-- Core scripts - Load with defer for better performance -->
    <script src="core.js" defer></script>
    <script src="subjects.js" defer></script>
    <script src="pomodoro.js" defer></script>
    <script src="streaks.js" defer></script>
    <script src="js/navigation.js" defer></script>

    <!-- Non-critical modules - Lazy load -->
    <script>
      // Funci√≥n para cargar m√≥dulos de forma diferida
      function loadModuleLazy(src, callback) {
        const script = document.createElement("script");
        script.src = src;
        script.defer = true;
        if (callback) script.onload = callback;
        document.head.appendChild(script);
      }

      // Cargar m√≥dulos no cr√≠ticos despu√©s de que la p√°gina est√© lista
      window.addEventListener("load", () => {
        setTimeout(() => {
          loadModuleLazy("reminders.js");
          loadModuleLazy("calendar.js", () => {
            // Inicializar calendario despu√©s de cargar el m√≥dulo
            if (typeof initializeCalendar === "function") {
              initializeCalendar();
            }
          });
        }, 100); // Peque√±o delay para no bloquear la UI
      });
    </script>
    <!-- Pruebas b√°sicas (solo en desarrollo) - Carga diferida -->
    <script>
      // Cargar pruebas solo si estamos en desarrollo
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        const script = document.createElement("script");
        script.src = "tests/basic-tests.js";
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>
    <script>
      // Inicializar la aplicaci√≥n
      document.addEventListener("DOMContentLoaded", function () {
        // Cargar datos
        state = loadData();

        // Migrar materias al formato expandido
        migrateSubjectsToExpandedFormat();

        // Inicializar sistemas
        if (typeof initializeStreaks === "function") {
          initializeStreaks();
        }
        // initializeCalendar se llama despu√©s de cargar calendar.js de forma diferida

        if (typeof loadPomodoroConfig === "function") {
          loadPomodoroConfig();
        }

        // Configurar event listeners del temporizador Pomodoro
        if (typeof setupPomodoroEventListeners === "function") {
          setupPomodoroEventListeners();
        }

        // Renderizar todo
        renderAll();

        // El modo oscuro ahora se maneja a trav√©s del MenuManager

        // Cargar configuraci√≥n del tema guardada
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          document.documentElement.setAttribute("data-theme", savedTheme);
          updateDarkModeToggle();
        }

        // Inicializar vista previa de sesi√≥n avanzada
        if (typeof updateSessionPreview === "function") {
          updateSessionPreview();
        }

        // Registrar Service Worker
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "Service Worker registrado exitosamente:",
                registration
              );
            })
            .catch((error) => {
              console.log("Error al registrar Service Worker:", error);
            });
        }
      });

      // Inicializar tema desde localStorage
      function initDarkMode() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
      }

      // Inicializar tema al cargar
      initDarkMode();
    </script>

    <!-- Modal para configurar objetivos -->
    <div id="goalModal" class="modal">
      <div class="modal-content">
        <h3>Configurar Objetivo Diario</h3>
        <label for="goalMinutes">Tiempo de estudio diario (minutos):</label>
        <input
          type="number"
          id="goalMinutes"
          min="30"
          max="480"
          value="60"
          step="15"
        />
        <div class="goal-suggestions">
          <button onclick="setQuickGoal(30)" class="btn-suggestion">
            30 min
          </button>
          <button onclick="setQuickGoal(60)" class="btn-suggestion">
            1 hora
          </button>
          <button onclick="setQuickGoal(90)" class="btn-suggestion">
            1.5 horas
          </button>
          <button onclick="setQuickGoal(120)" class="btn-suggestion">
            2 horas
          </button>
        </div>
        <div class="modal-actions">
          <button onclick="closeModal('goalModal')" class="btn-cancel">
            Cancelar
          </button>
          <button onclick="saveGoal()" class="btn-confirm">Guardar</button>
        </div>
      </div>
    </div>

    <!-- Modal para configurar Pomodoro Avanzado -->
    <div id="pomodoroConfigModal" class="modal">
      <div class="modal-content">
        <h3>‚öôÔ∏è Configurar Sesi√≥n de Estudio</h3>

        <div class="pomodoro-config">
          <div class="config-tabs">
            <button class="tab-btn active" onclick="switchTab('simple')">
              Simple
            </button>
            <button class="tab-btn" onclick="switchTab('advanced')">
              Avanzado
            </button>
          </div>
        </div>

        <!-- Configuraci√≥n Simple -->
        <div id="simpleConfig" class="config-tab active">
          <div class="config-section">
            <label for="workDuration">Tiempo de trabajo (minutos):</label>
            <input
              type="number"
              id="workDuration"
              min="30"
              max="90"
              value="30"
              step="5"
            />
            <div class="time-suggestions">
              <button onclick="setWorkTime(30)" class="btn-suggestion">
                30 min
              </button>
              <button onclick="setWorkTime(45)" class="btn-suggestion">
                45 min
              </button>
              <button onclick="setWorkTime(60)" class="btn-suggestion">
                60 min
              </button>
              <button onclick="setWorkTime(90)" class="btn-suggestion">
                90 min
              </button>
            </div>
          </div>

          <div class="config-section">
            <label for="breakDuration">Tiempo de descanso (minutos):</label>
            <input
              type="number"
              id="breakDuration"
              min="1"
              max="30"
              value="5"
              step="1"
            />
            <div class="time-suggestions">
              <button onclick="setBreakTime(5)" class="btn-suggestion">
                5 min
              </button>
              <button onclick="setBreakTime(10)" class="btn-suggestion">
                10 min
              </button>
            </div>
          </div>
        </div>

        <!-- Configuraci√≥n Avanzada -->
        <div id="advancedConfig" class="config-tab">
          <div class="config-section">
            <label for="totalTime">Tiempo total de estudio (minutos):</label>
            <input
              type="number"
              id="totalTime"
              min="30"
              max="180"
              value="60"
              step="15"
            />
            <div class="time-suggestions">
              <button onclick="setTotalTime(60)" class="btn-suggestion">
                1 hora
              </button>
              <button onclick="setTotalTime(90)" class="btn-suggestion">
                1.5 horas
              </button>
              <button onclick="setTotalTime(120)" class="btn-suggestion">
                2 horas
              </button>
              <button onclick="setTotalTime(150)" class="btn-suggestion">
                2.5 horas
              </button>
            </div>
          </div>

          <div class="config-section">
            <label for="breakLength">Duraci√≥n de cada pausa (minutos):</label>
            <input
              type="number"
              id="breakLength"
              min="5"
              max="20"
              value="15"
              step="5"
            />
            <div class="time-suggestions">
              <button onclick="setBreakLength(10)" class="btn-suggestion">
                10 min
              </button>
              <button onclick="setBreakLength(20)" class="btn-suggestion">
                20 min
              </button>
            </div>
          </div>

          <div class="config-section">
            <label for="numberOfBreaks">N√∫mero de pausas:</label>
            <select id="numberOfBreaks">
              <option value="1">1 pausa</option>
              <option value="2" selected>2 pausas</option>
              <option value="3">3 pausas</option>
              <option value="4">4 pausas</option>
            </select>
          </div>

          <div class="config-preview">
            <h4>Vista previa de la sesi√≥n:</h4>
            <div id="sessionPreview" class="session-preview"></div>
          </div>
        </div>

        <div class="config-section">
          <label for="autoTransition">Transiciones autom√°ticas:</label>
          <div class="checkbox-group">
            <label>
              <input type="checkbox" id="autoStartBreak" checked /> Iniciar
              pausas autom√°ticamente
            </label>
            <label>
              <input type="checkbox" id="autoStartWork" checked /> Continuar
              estudio autom√°ticamente
            </label>
          </div>
        </div>

        <div class="modal-actions">
          <button
            onclick="closeModal('pomodoroConfigModal')"
            class="btn-cancel"
          >
            Cancelar
          </button>
          <button onclick="savePomodoroConfig()" class="btn-confirm">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Screen Script -->
    <script src="js/loading.js"></script>

    <!-- Menu Script - Cargar inmediatamente -->
    <script src="js/menu.js"></script>

    <!-- Script adicional para asegurar inicializaci√≥n del men√∫ -->
    <script>
      // Asegurar que el men√∫ se inicialice correctamente
      document.addEventListener("DOMContentLoaded", function () {
        // Verificar si el men√∫ ya se inicializ√≥
        if (!window.menuManager) {
          console.log("üîÑ Reinitializing menu...");
          setTimeout(() => {
            if (typeof MenuManager !== "undefined") {
              window.menuManager = new MenuManager();
              if (window.menuManager.findElements()) {
                window.menuManager.init();
              }
            }
          }, 100);
        }
      });
    </script>
  </body>
</html>
